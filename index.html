# Build a one-page HTML site (no frameworks) with anchor tabs and R/Y/G heatmap thresholds
import pandas as pd
import numpy as np
from pathlib import Path
import html

src = "/mnt/data/20251014_viz_processed.xlsx"

vita = pd.read_excel(src, sheet_name="Vita_Merged")
dewo = pd.read_excel(src, sheet_name="Deworm_Merged")
muac = pd.read_excel(src, sheet_name="MUAC_Merged")
overall = pd.read_excel(src, sheet_name="Overall_Coverage")

def to_num(x):
    try:
        return float(x)
    except Exception:
        return np.nan

def getcol(df, *names):
    for n in names:
        for c in df.columns:
            if c.lower() == n.lower():
                return c
    for n in names:
        for c in df.columns:
            if n.lower() in c.lower():
                return c
    return None

def normalize_common(df):
    d = df.copy()
    st = getcol(d,"State","state","Province")
    if st and st != "State":
        d = d.rename(columns={st:"State"})
    ct = getcol(d,"county","County")
    if ct and ct != "county":
        d = d.rename(columns={ct:"county"})
    return d

vita = normalize_common(vita)
dewo = normalize_common(dewo)
muac = normalize_common(muac)

overall_map = {str(r["Metric"]).strip(): to_num(r["OverallCoverage(%)"]) for _, r in overall.iterrows()}

# Heatmap thresholds: <50 red, [50,80) yellow, >=80 green
def heat_threshold_rgb(p):
    if p is None or np.isnan(p):
        return ("", "#0b1b2b")
    v = float(p)
    if v < 50:
        bg = "hsl(2, 82%, 85%)"    # soft red
        fg = "#7a1111"
    elif v < 80:
        bg = "hsl(47, 90%, 85%)"   # soft yellow
        fg = "#5a4a00"
    else:
        bg = "hsl(140, 55%, 80%)"  # soft green
        fg = "#0e3d1f"
    # For very dark (if we change later), ensure contrast
    return (bg, fg)

def fmt_int(x):
    if pd.isna(x):
        return ""
    return f"{int(round(float(x))):,}"

def fmt_pct(x):
    if pd.isna(x):
        return ""
    return f"{float(x):.1f}%"

def build_table_html(df, columns, caption=None):
    df2 = df.copy()
    sort_cols = [c for c in ["State","county"] if c in df2.columns]
    if sort_cols:
        df2 = df2.sort_values(by=sort_cols)
    thead = "<thead><tr>" + "".join(f"<th>{html.escape(col['label'])}</th>" for col in columns) + "</tr></thead>"
    body_rows = []
    for _, row in df2.iterrows():
        tds = []
        for col in columns:
            key = col["key"]
            fmt = col.get("fmt","text")
            heat = col.get("heat", False)
            val = row.get(key, np.nan)
            txt = ""
            style = ""
            cls = ""
            if fmt == "num":
                txt = fmt_int(to_num(val))
                cls = "num"
            elif fmt == "pct":
                v = to_num(val)
                txt = fmt_pct(v)
                cls = "num"
                if heat and not pd.isna(v):
                    bg, fg = heat_threshold_rgb(v)
                    style = f" style='background:{bg};color:{fg};'"
            else:
                txt = "" if pd.isna(val) else str(val)
            tds.append(f"<td class='{cls}'{style}>{html.escape(txt)}</td>")
        body_rows.append("<tr>" + "".join(tds) + "</tr>")
    tbody = "<tbody>" + "".join(body_rows) + "</tbody>"
    cap = f"<caption>{html.escape(caption)}</caption>" if caption else ""
    return f"<table>{cap}{thead}{tbody}</table>"

# Column specs
vita_cols = [
    {"key":"State","label":"State"},
    {"key":"county","label":"County"},
    {"key":"vita6to59months","label":"# Reached (6–59m)","fmt":"num"},
    {"key":"vitapop","label":"Target Pop","fmt":"num"},
    {"key":"VitaCoverage","label":"Coverage % (County)","fmt":"pct","heat":True},
    {"key":"VitaCoverageState","label":"Coverage % (State)","fmt":"pct","heat":True},
]
dewo_cols = [
    {"key":"State","label":"State"},
    {"key":"county","label":"County"},
    {"key":"deworm12to59months","label":"# Reached (12–59m)","fmt":"num"},
    {"key":"dewormpop","label":"Target Pop","fmt":"num"},
    {"key":"DewormCoverage","label":"Coverage % (County)","fmt":"pct","heat":True},
    {"key":"DewormCoverageState","label":"Coverage % (State)","fmt":"pct","heat":True},
]
muac_cols = [
    {"key":"State","label":"State"},
    {"key":"county","label":"County"},
    {"key":"muac6to59months","label":"# Screened (6–59m)","fmt":"num"},
    {"key":"vitapop","label":"Target Pop","fmt":"num"},
    {"key":"muacCoverage","label":"Coverage % (County)","fmt":"pct","heat":True},
    {"key":"muacCoverageState","label":"Coverage % (State)","fmt":"pct","heat":True},
]

vita_table = build_table_html(vita, vita_cols, "All counties — Vitamin A coverage")
dewo_table = build_table_html(dewo, dewo_cols, "All counties — Deworming coverage")
muac_table = build_table_html(muac, muac_cols, "All counties — MUAC screening coverage")

# CSS + layout (UNICEF blue background, compact tables)
CSS = """
:root{
  --unicef-blue:#00ADEF; --ink:#0b1b2b; --muted:#648199; --card:#ffffff;
  --shadow:0 10px 30px rgba(0,0,0,.06); --border:#e6f1f8;
}
*{box-sizing:border-box}
html,body{margin:0;height:100%}
body{
  font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;
  color:var(--ink);
  background: radial-gradient(1400px 700px at 50% -280px, #7cd7f7 0%, #2fbceb 35%, var(--unicef-blue) 60%, #e9f6ff 60%, #ffffff 100%);
  background-attachment: fixed;
}
.container{max-width:1180px;margin:0 auto;padding:24px}
header{position:sticky;top:0;z-index:50;background:linear-gradient(90deg, var(--unicef-blue), #0088bb);color:white;box-shadow:var(--shadow)}
.nav{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.brand{font-weight:800;letter-spacing:.2px;font-size:18px;padding:10px 0}
.nav a{color:white;text-decoration:none;padding:8px 12px;border-radius:999px;opacity:.95}
.nav a:hover{background:rgba(255,255,255,.16)}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:var(--shadow)}
h1{font-size:28px;margin:10px 0 6px}
h2{font-size:22px;margin:12px 0 6px}
.lead{color:var(--muted)}
.badges{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.badge{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;background:#fff;border:1px solid #d7eef9;box-shadow:var(--shadow)}
.section{scroll-margin-top:90px}
.tableWrap{overflow:auto;border:1px solid var(--border);border-radius:12px}
table{width:100%;border-collapse:separate;border-spacing:0;font-size:13px}
caption{caption-side:top;text-align:left;padding:8px 12px;color:var(--muted)}
thead th{position:sticky;top:0;background:#f5fbff;color:#003a54;border-bottom:1px solid #dcecf7;font-weight:700}
th,td{padding:6px 8px;text-align:left;white-space:nowrap}
tbody tr:nth-child(odd){background:#fbfdff}
tbody tr:hover{background:#f0f8ff}
.num{font-variant-numeric:tabular-nums}
.kpis{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
.kpi{background:#fff;border:1px solid #d7eef9;border-radius:12px;padding:12px;display:flex;justify-content:space-between;align-items:center}
.kpi .value{min-width:86px;text-align:center;font-weight:800;border-radius:10px;padding:8px 10px}
.footer{margin-top:30px;padding:18px 0;background:linear-gradient(90deg, #0088bb, var(--unicef-blue));color:white}
.footer a{color:white}
"""

NAV = """
<header>
  <div class="container nav">
    <div class="brand">UNICEF · Vitamin A Campaign</div>
    <nav style="margin-left:auto;display:flex;gap:6px;flex-wrap:wrap">
      <a href="#about">About</a>
      <a href="#vitamin-a">Vitamin A</a>
      <a href="#deworming">Deworming</a>
      <a href="#muac">MUAC Screening</a>
    </nav>
  </div>
</header>
"""

def kpi_card(label, pct):
    # Map to the same threshold colors (for consistency)
    bg, fg = heat_threshold_rgb(pct if pct is not None and not np.isnan(pct) else None)
    valtxt = "" if pct is None or np.isnan(pct) else f"{pct:.1f}%"
    return f"""
      <div class="kpi">
        <div>
          <div style="font-weight:700">{html.escape(label)}</div>
          <div class="lead" style="font-size:12px">Overall coverage</div>
        </div>
        <div class="value" style="background:{bg};color:{fg};box-shadow:inset 0 0 0 1px rgba(0,0,0,.04)">{valtxt}</div>
      </div>
    """

about = f"""
<section id="about" class="section">
  <div class="card">
    <h1>Vitamin A, Deworming & Mass MUAC Screening</h1>
    <p class="lead">An integrated campaign to protect and nourish children 6–59 months across all counties in South Sudan.
    This site presents county-by-county coverage for Vitamin A supplementation, Deworming, and MUAC screening, including state and overall indicators.</p>
    <div class="badges">
      <div class="badge"><strong>UNICEF-led</strong></div>
      <div class="badge"><strong>National Coverage</strong></div>
      <div class="badge"><strong>County Breakdown</strong></div>
    </div>
    <div style="margin-top:12px">
      <div class="kpis">
        {kpi_card("Vitamin A", overall_map.get("VitaCoverageOverall"))}
        {kpi_card("Deworming", overall_map.get("DewormCoverageOverall"))}
        {kpi_card("MUAC Screening", overall_map.get("muacCoverageOverall"))}
      </div>
    </div>
  </div>
</section>
"""

vita_sec = f"""
<section id="vitamin-a" class="section">
  <h2>Vitamin A</h2>
  <p class="lead">County coverage for children 6–59 months. Heatmap coloring: <strong style="color:#7a1111">red &lt; 50%</strong>, <strong style="color:#5a4a00">yellow 50–79.9%</strong>, <strong style="color:#0e3d1f">green ≥ 80%</strong>.</p>
  <div class="kpis">{kpi_card("Vitamin A", overall_map.get("VitaCoverageOverall"))}</div>
  <div style="height:10px"></div>
  <div class="card tableWrap">{vita_table}</div>
</section>
"""

dewo_sec = f"""
<section id="deworming" class="section">
  <h2>Deworming</h2>
  <p class="lead">County coverage for children 12–59 months. Same heatmap thresholds.</p>
  <div class="kpis">{kpi_card("Deworming", overall_map.get("DewormCoverageOverall"))}</div>
  <div style="height:10px"></div>
  <div class="card tableWrap">{dewo_table}</div>
</section>
"""

muac_sec = f"""
<section id="muac" class="section">
  <h2>MUAC Screening</h2>
  <p class="lead">County-level screening coverage for children 6–59 months. Same heatmap thresholds.</p>
  <div class="kpis">{kpi_card("MUAC Screening", overall_map.get("muacCoverageOverall"))}</div>
  <div style="height:10px"></div>
  <div class="card tableWrap">{muac_table}</div>
</section>
"""

html_page = f"""<!DOCTYPE html>
<html lang="en">
<head><meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>UNICEF · Vitamin A Campaign — One-Page</title>
<style>{CSS}</style>
</head>
<body>
{NAV}
<main class="container">
{about}
{vita_sec}
{dewo_sec}
{muac_sec}
</main>
<footer class="footer">
  <div class="container" style="display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between">
    <div><strong>UNICEF · South Sudan</strong> — Vitamin A Campaign</div>
    <div class="lead" style="font-size:12px">Data workbook: <a href="sandbox:/mnt/data/20251014_viz_processed.xlsx">download</a></div>
  </div>
</footer>
</body></html>
"""

out_path = "/mnt/data/vitamin_a_campaign_onepage_threshold_heatmap.html"
Path(out_path).write_text(html_page, encoding="utf-8")
out_path
